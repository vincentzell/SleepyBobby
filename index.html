<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleepy Bobby</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --primary: #38bdf8;
            --accent: #fb7185;
            --bird-grey: #b8b0a5;
            --bird-dark-grey: #8d7e71;
            --bird-orange: #e65a28;
            --branch-brown: #8b5d43;
        }

        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; background: var(--bg); font-family: system-ui, sans-serif; }
        body { display: flex; align-items: center; justify-content: center; }

        .container { width: 100%; max-width: 380px; padding: 20px; text-align: center; position: relative; z-index: 10; }

        .card {
            background: var(--card); padding: 2.5rem 2rem; border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); position: relative; z-index: 20; color: var(--text);
        }

        /* --- BOBBY --- */
        .play-btn-wrapper { position: relative; margin: 10px auto 30px; width: 160px; height: 150px; display: flex; justify-content: center; align-items: center; }
        .play-btn { width: 140px; height: 140px; border: none; background: none; cursor: pointer; position: relative; z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; outline: none; }
        
        .branch { position: absolute; width: 140px; height: 12px; background: var(--branch-brown); bottom: 35px; left: 50%; transform: translateX(-50%); border-radius: 10px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .bird-body { width: 90px; height: 100px; background: var(--bird-grey); border-radius: 50% 50% 45% 45%; position: relative; overflow: hidden; z-index: 30; transition: box-shadow 1s ease; }
        .head-top { position: absolute; top: 0; left: 20%; width: 60%; height: 25px; background: var(--bird-dark-grey); border-radius: 0 0 15px 15px; }
        .chest { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; background: var(--bird-orange); border-radius: 50%; transition: background 0.5s ease; }
        .eyes { position: absolute; top: 35px; width: 45px; display: flex; justify-content: space-between; left: 50%; transform: translateX(-50%); }
        .eye { width: 7px; height: 7px; background: #1a1a1a; border-radius: 50%; transition: all 0.3s ease; }
        .beak { position: absolute; top: 42px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 7px solid #f1c40f; }
        .legs { display: flex; justify-content: center; gap: 15px; position: absolute; bottom: 38px; z-index: 40; }
        .leg { width: 8px; height: 12px; background: var(--bird-dark-grey); border-radius: 3px; }
        .tail { width: 25px; height: 40px; background: var(--bird-grey); border-radius: 0 0 10px 10px; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 10; }

        /* Animations */
        .play-btn.playing .bird-body { animation: breathe 4s ease-in-out infinite; }
        .play-btn.playing .eye { height: 2px; border-radius: 2px; margin-top: 3px; }
        .playing-state .branch { animation: sway 4s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
        @keyframes sway { 0%, 100% { transform: translateX(-50%) rotate(0deg); } 50% { transform: translateX(-50%) rotate(1.5deg); } }

        /* Effet spécial Feu */
        .glow-fire { box-shadow: 0 0 20px rgba(230, 90, 40, 0.6); }

        /* --- TEXTE --- */
        #bobbyPhrase { min-height: 48px; margin: 0 0 20px 0; opacity: 0.7; font-size: 0.9rem; line-height: 1.4; transition: opacity 0.4s ease, transform 0.4s ease; }
        .phrase-fade { opacity: 0 !important; transform: translateY(5px); }

        /* --- VISUELS --- */
        .anim-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 5; overflow: hidden; }
        .ripple { position: absolute; border: 2px solid var(--primary); border-radius: 50%; transform: translate(-50%, -50%); animation: rippleEffect 4s cubic-bezier(0, 0.3, 0.7, 1) forwards; opacity: 0; }
        @keyframes rippleEffect { 0% { width: 0; height: 0; opacity: 0.6; } 100% { width: 400px; height: 400px; opacity: 0; } }
        
        .rain-drop { position: absolute; background: var(--primary); width: 2px; height: 15px; opacity: 0.4; animation: fall 0.8s linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* CONTROLES */
        .control-group { text-align: left; margin-top: 15px; }
        .label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; opacity: 0.5; margin-bottom: 5px; display: block; }
        select { width: 100%; padding: 12px; border-radius: 12px; background: #2d3748; border: 1px solid rgba(255,255,255,0.1); color: white; appearance: none; cursor: pointer; outline: none; }
        input[type=range] { width: 100%; height: 6px; appearance: none; background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; border: 3px solid var(--card); }
    </style>
</head>
<body>

    <div class="anim-container" id="animContainer"></div>

    <div class="container" id="mainContainer">
        <div class="card">
            <h1 style="margin: 0 0 5px 0;">Sleepy Bobby</h1>
            <p id="bobbyPhrase"></p>
            
            <div class="play-btn-wrapper">
                <button id="playBtn" class="play-btn">
                    <div class="bird-body" id="bobbyBody">
                        <div class="head-top"></div><div class="chest" id="bobbyChest"></div>
                        <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
                        <div class="beak"></div>
                    </div>
                    <div class="legs"><div class="leg"></div><div class="leg"></div></div>
                    <div class="tail"></div>
                    <div class="branch"></div>
                </button>
            </div>

            <div class="control-group">
                <span class="label">Ambiance</span>
                <select id="modeSelect">
                    <option value="river">Rivière Douce</option>
                    <option value="rain">Pluie (Dublin Rain)</option>
                    <option value="wind">Vent (Pins Landais)</option>
                    <option value="fire">Cheminée (Irish Cottage)</option>
                    <option value="space">Espace (Head in Clouds)</option>
                </select>
            </div>
            
            <div class="control-group">
                <span class="label">Minuteur</span>
                <select id="timerSelect">
                    <option value="0" data-label="∞">∞</option>
                    <option value="10" data-label="10 Minutes">10 Minutes</option>
                    <option value="30" data-label="30 Minutes">30 Minutes</option>
                </select>
            </div>

            <div class="control-group">
                <span class="label">Volume <span id="volPerc">100%</span></span>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="1.0">
            </div>
        </div>
    </div>

    <script>
        const phrases = [
            "Bobby ébouriffe ses plumes pour te border.",
            "Chut... Bobby troque son chant contre un doux murmure.",
            "Bobby says bonne nuit and wishes you sweet dreams.",
            "Bobby rêve de trèfles irlandais et de jardins français.",
            "Slán abhaile... Bobby te souhaite un doux retour au pays des songes.",
            "Bobby has his head in the clouds, entre Dublin et Paris."
        ];

        const phraseElement = document.getElementById('bobbyPhrase');
        const animContainer = document.getElementById('animContainer');
        const bobbyBody = document.getElementById('bobbyBody');
        const bobbyChest = document.getElementById('bobbyChest');
        
        function updatePhrase() {
            phraseElement.classList.add('phrase-fade');
            setTimeout(() => {
                phraseElement.textContent = phrases[Math.floor(Math.random() * phrases.length)];
                phraseElement.classList.remove('phrase-fade');
            }, 400);
        }
        updatePhrase();

        let audioCtx, gainNode, sourceNode, visualInterval;
        let isPlaying = false;

        // --- GÉNÉRATEURS DE SON ---
        function createNoiseBuffer(ctx, type) {
            const bufSize = ctx.sampleRate * 2;
            const buffer = ctx.createBuffer(1, bufSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            let lastOut = 0;

            for (let i = 0; i < bufSize; i++) {
                const white = Math.random() * 2 - 1;
                if (type === 'pink') { // Utilisé pour pluie/vent
                    lastOut = (lastOut + (0.02 * white)) / 1.02;
                    data[i] = lastOut * 3.5;
                } else if (type === 'brown') { // Utilisé pour espace/feu
                    lastOut = (lastOut + (0.01 * white)) / 1.01;
                    data[i] = lastOut * 8;
                }
            }
            return buffer;
        }

        function startAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            sourceNode = audioCtx.createBufferSource();
            const mode = document.getElementById('modeSelect').value;
            
            // Configuration du son selon le mode
            if (mode === 'river' || mode === 'rain') sourceNode.buffer = createNoiseBuffer(audioCtx, 'pink');
            else sourceNode.buffer = createNoiseBuffer(audioCtx, 'brown');
            
            sourceNode.loop = true;
            gainNode = audioCtx.createGain();
            gainNode.gain.value = document.getElementById('volume').value;
            
            // Filtre pour adoucir le son
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.value = mode === 'space' ? 300 : 800;

            sourceNode.connect(filter).connect(gainNode).connect(audioCtx.destination);
            sourceNode.start();
        }

        // --- VISUELS DYNAMIQUES ---
        function updateVisuals() {
            animContainer.innerHTML = '';
            clearInterval(visualInterval);
            bobbyBody.classList.remove('glow-fire');
            
            if (!isPlaying) return;
            const mode = document.getElementById('modeSelect').value;

            if (mode === 'river') {
                visualInterval = setInterval(() => {
                    const r = document.createElement('div');
                    r.className = 'ripple';
                    r.style.left = (40 + Math.random() * 20) + '%';
                    r.style.top = (40 + Math.random() * 20) + '%';
                    animContainer.appendChild(r);
                    setTimeout(() => r.remove(), 4000);
                }, 1500);
            } else if (mode === 'rain') {
                visualInterval = setInterval(() => {
                    const d = document.createElement('div');
                    d.className = 'rain-drop';
                    d.style.left = Math.random() * 100 + '%';
                    d.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                    animContainer.appendChild(d);
                    setTimeout(() => d.remove(), 1000);
                }, 50);
            } else if (mode === 'fire') {
                bobbyBody.classList.add('glow-fire');
                visualInterval = setInterval(() => {
                    const flicker = 0.8 + Math.random() * 0.4;
                    bobbyChest.style.background = `rgba(230, 90, 40, ${flicker})`;
                }, 100);
            }
        }

        async function togglePlay() {
            if (!isPlaying) {
                updatePhrase();
                startAudio();
                document.getElementById('playBtn').classList.add('playing');
                document.getElementById('mainContainer').classList.add('playing-state');
                isPlaying = true;
            } else {
                if(sourceNode) sourceNode.stop();
                document.getElementById('playBtn').classList.remove('playing');
                document.getElementById('mainContainer').classList.remove('playing-state');
                isPlaying = false;
            }
            updateVisuals();
        }

        document.getElementById('playBtn').addEventListener('click', togglePlay);
        document.getElementById('modeSelect').addEventListener('change', () => { if(isPlaying) { togglePlay(); togglePlay(); } });
        document.getElementById('volume').addEventListener('input', (e) => {
            document.getElementById('volPerc').textContent = Math.round(e.target.value * 100) + "%";
            if(gainNode) gainNode.gain.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.1);
        });
    </script>
</body>
</html>
